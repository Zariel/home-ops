---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

vars:
  TALOS_VERSION: v1.7.1
  TALOS_SCHEMATIC_ID: 6052c254ad4865b0d7b905cd00bbdb54053e7dbe0615e1dedbf8121256f328d7
  KUBERNETES_VERSION: v1.30.0
  TALOS_SCRIPTS_DIR: "{{.ROOT_DIR}}/.taskfiles/Talos/scripts"

tasks:
  generate:
    desc: Run talhelper to generate manifests
    dir: "{{.ROOT_DIR}}/talos"
    cmds:
      - talhelper genconfig --out-dir={{.ROOT_DIR}}/talos/clusterconfig

  reset-cluster:
    desc: Reset Talos across the whole cluster
    prompt: Reset the Talos cluster ... continue?
    cmd: talosctl reset --nodes {{.NODES}} --graceful=false
    vars:
      NODES:
        sh: talosctl config info --output json | jq --exit-status --join-output '[.nodes[]] | join(",")'
    preconditions:
      - talosctl --nodes {{.NODES}} get machineconfig
      - which jq talosctl

  fetch-kubeconfig:
    desc: Fetch kubeconfig from Talos controllers
    cmd: |
      talosctl kubeconfig --nodes {{.controller}} \
          --force {{.ROOT_DIR}}/kubeconfig.yaml
    requires:
      vars: ["controller"]
