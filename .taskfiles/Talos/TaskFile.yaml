---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

vars:
  TALOS_SCRIPTS_DIR: "{{.ROOT_DIR}}/.taskfiles/Talos/scripts"

tasks:
  generate:
    desc: Run talhelper to generate manifests
    dir: "{{.ROOT_DIR}}/talos"
    cmds:
      - talhelper genconfig --out-dir={{.ROOT_DIR}}/talos/clusterconfig

  reset-cluster:
    desc: Reset Talos across the whole cluster
    prompt: Reset the Talos cluster ... continue?
    cmd: talosctl reset --nodes {{.NODES}} --graceful=false
    vars:
      NODES:
        sh: talosctl config info --output json | jq --exit-status --join-output '[.nodes[]] | join(",")'
    preconditions:
      - talosctl --nodes {{.NODES}} get machineconfig
      - which jq talosctl

  fetch-kubeconfig:
    desc: Fetch kubeconfig from Talos controllers
    cmd: |
      talosctl kubeconfig --nodes {{.controller}} \
          --force {{.ROOT_DIR}}/kubeconfig.yaml
    requires:
      vars: ["controller"]

  matchbox:bundle:
    desc: Build matchbox bundle (assets, profiles, groups) using talhelper outputs
    cmds:
      - bash {{.ROOT_DIR}}/.taskfiles/Talos/scripts/matchbox_bundle.sh

  matchbox:push:
    desc: Build and push matchbox bundle to VyOS (rsync --delete)
    deps: ["matchbox:bundle"]
    env:
      HOST: "{{.host | default \"vyos@gateway\"}}"
    cmds:
      - rsync -av --delete {{.ROOT_DIR}}/artifacts/matchbox/ ${HOST}:/config/containers/matchbox/

  matchbox:clean:
    desc: Remove generated matchbox artifacts and cached schematic id
    cmds:
      - rm -rf {{.ROOT_DIR}}/artifacts/matchbox
      - rm -f {{.ROOT_DIR}}/talos/.cache/schematic.id {{.ROOT_DIR}}/talos/.cache/schematic.key
