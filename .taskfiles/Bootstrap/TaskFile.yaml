---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

tasks:
  talos:
    desc: Bootstrap Talos cluster
    summary: |
      Bootstrap flow:
        1. Bootstrap etcd
        2. Fetch kubeconfig (from controller node)
        3. Install networking (Cilium + Bird)
        4. Update kubeconfig (switch to LoadBalancer VIP)
        5. Install CoreDNS
        6. Install CRDs
        7. Bootstrap Flux

      Args:
        controller: Controller node IP (required)

      Example:
        task bootstrap:talos controller=10.254.1.1
    prompt: Bootstrap Talos cluster... continue?
    cmds:
      - task: etcd
        vars: { controller: "{{.controller}}" }
      - task: kubeconfig
        vars: { controller: "{{.controller}}" }
      - task: networking
      - task: kubeconfig-vip
      - task: dns
      - task: crds
      - task: flux
    requires:
      vars: ["controller"]

  etcd:
    desc: Bootstrap etcd cluster
    cmd: |
      set -euo pipefail
      if talosctl --nodes {{.controller}} service etcd >/dev/null 2>&1; then
        echo "Etcd already bootstrapped, skipping"
        exit 0
      fi
      echo "Bootstrapping etcd..."
      until talosctl --nodes {{.controller}} bootstrap; do
        echo "Retrying etcd bootstrap in 10s..."
        sleep 10
      done
    requires:
      vars: ["controller"]

  kubeconfig:
    desc: Fetch kubeconfig from controller node
    cmds:
      - |
        talosctl kubeconfig --nodes {{.controller}} \
            --force {{.ROOT_DIR}}/kubeconfig.yaml
      - |
        kubectl config set-cluster hollywoo \
          --server=https://{{.controller}}:6443 \
          --kubeconfig={{.ROOT_DIR}}/kubeconfig.yaml
    requires:
      vars: ["controller"]

  networking:
    desc: Install CNI (Cilium) and BGP (Bird)
    cmds:
      - kustomize build --enable-helm --load-restrictor=LoadRestrictionsNone {{.KUBERNETES_DIR}}/bootstrap/cilium | kubectl apply --server-side -f -
      - kubectl wait --for=condition=Established crd/ciliumloadbalancerippools.cilium.io --timeout=120s
      - kubectl wait --for=condition=Established crd/ciliumbgpclusterconfigs.cilium.io --timeout=120s
      - kubectl wait --for=condition=Established crd/ciliumbgppeerconfigs.cilium.io --timeout=120s
      - kubectl wait --for=condition=Established crd/ciliumbgpadvertisements.cilium.io --timeout=120s
      - kubectl apply --server-side -k {{.KUBERNETES_DIR}}/bootstrap/cilium-networks

      - kubectl apply --server-side -k {{.KUBERNETES_DIR}}/bootstrap/bird
      - kubectl rollout status daemonset/bird -n kube-system --timeout=300s

      - until kubectl wait --for=condition=Ready nodes --all --timeout=600s; do sleep 10; done

      - until kubectl get service kube-vip -n kube-system -o jsonpath='{.status.loadBalancer.ingress[0].ip}' | grep -q '10.45.0.100'; do sleep 5; done

  kubeconfig-vip:
    desc: Update kubeconfig to use LoadBalancer VIP
    cmds:
      - |
        talosctl kubeconfig --nodes {{.controller}} \
          --endpoints 10.45.0.100 \
          --force {{.ROOT_DIR}}/kubeconfig.yaml

  dns:
    desc: Install CoreDNS
    cmds:
      - kustomize build --enable-helm --load-restrictor=LoadRestrictionsNone {{.KUBERNETES_DIR}}/bootstrap/coredns | kubectl apply --server-side -f -
      - kubectl rollout status deployment/coredns -n kube-system --timeout=300s

  crds:
    desc: Install CRDs required by Flux apps
    cmds:
      - kubectl apply --server-side -k {{.KUBERNETES_DIR}}/bootstrap/crds

  flux:
    desc: Bootstrap Flux GitOps
    dir: "{{.KUBERNETES_DIR}}/bootstrap/flux"
    cmds:
      - kubectl apply --server-side -k {{.KUBERNETES_DIR}}/bootstrap/flux

      - sops --decrypt sops-age.sops.yaml | kubectl apply --server-side -f -
      - sops --decrypt github-deploy-key.sops.yaml | kubectl apply --server-side -f -

      - kubectl apply --server-side -k {{.KUBERNETES_DIR}}/flux/config

  validate-bgp:
    desc: Validate BGP peering between Cilium and Bird
    cmds:
      - kubectl exec -n kube-system daemonset/cilium -- cilium bgp peers
      - kubectl exec -n kube-system daemonset/bird -- birdcl show protocols cilium

  validate-ospf:
    desc: Validate OSPF peering between Bird and upstream router
    cmds:
      - kubectl exec -n kube-system daemonset/bird -- birdcl show protocols beefchunk
      - kubectl exec -n kube-system daemonset/bird -- birdcl show ospf neighbors

  validate-routing:
    desc: Validate pod routing across nodes
    cmds:
      - kubectl exec -n kube-system daemonset/bird -- birdcl show route all
      - kubectl get svc kube-vip -n kube-system
