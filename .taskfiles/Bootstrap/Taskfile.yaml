---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

tasks:
  talos:
    desc: Bootstrap Talos cluster
    summary: |
      Bootstrap flow:
        1. Bootstrap etcd
        2. Fetch kubeconfig (from controller node)
        3. Install networking (Cilium)
        4. Update kubeconfig (switch to LoadBalancer VIP)
        5. Install CoreDNS
        6. Install CRDs
        7. Bootstrap Flux

      Args:
        controller: Controller node IP (required)

      Example:
        task bootstrap:talos controller=10.254.1.1
    prompt: Bootstrap Talos cluster... continue?
    cmds:
      - task: etcd
        vars: { controller: "{{.controller}}" }
      - task: kubeconfig
        vars: { controller: "{{.controller}}" }
      - task: networking
      - task: kubeconfig-vip
        vars: { controller: "{{.controller}}" }
      - task: dns
      - task: crds
      - task: flux
    requires:
      vars: ["controller"]

  etcd:
    desc: Bootstrap etcd cluster
    cmd: |
      set -euo pipefail
      echo "Bootstrapping etcd..."
      until talosctl --nodes {{.controller}} bootstrap; do
        if talosctl --nodes {{.controller}} etcd member list >/dev/null 2>&1; then
          echo "Etcd already bootstrapped, skipping"
          exit 0
        fi

        echo "Retrying etcd bootstrap in 10s..."
        sleep 10
      done
    requires:
      vars: ["controller"]

  kubeconfig:
    desc: Fetch kubeconfig from controller node
    cmds:
      - |
        talosctl kubeconfig --nodes {{.controller}} \
            --force {{.ROOT_DIR}}/kubeconfig.yaml
      - |
        kubectl config set-cluster hollywoo \
          --server=https://{{.controller}}:6443 \
          --kubeconfig={{.ROOT_DIR}}/kubeconfig.yaml
    requires:
      vars: ["controller"]

  networking:
    desc: Install CNI
    cmds:
      - kustomize build --enable-helm --load-restrictor=LoadRestrictionsNone {{.KUBERNETES_DIR}}/bootstrap/cilium | kubectl apply --validate=false --server-side -f -
      - |
        set -euo pipefail
        for crd in \
          ciliumloadbalancerippools.cilium.io \
          ciliumbgpclusterconfigs.cilium.io \
          ciliumbgppeerconfigs.cilium.io \
          ciliumbgpadvertisements.cilium.io; do
          attempt=1
          until kubectl wait --for=condition=Established crd/${crd} --timeout=30s; do
            if [ $attempt -ge 12 ]; then
              echo "Timed out waiting for CRD ${crd} to become established"
              exit 1
            fi
            echo "CRD ${crd} not ready yet (attempt ${attempt}), retrying in 10s..."
            attempt=$((attempt+1))
            sleep 10
          done
        done
      - kubectl apply --validate=false --server-side -k {{.KUBERNETES_DIR}}/bootstrap/cilium-networks
      - until kubectl wait --for=condition=Ready nodes --all --timeout=600s; do sleep 10; done

      - until kubectl get service kube-vip -n kube-system -o jsonpath='{.status.loadBalancer.ingress[0].ip}' | grep -q '10.45.0.100'; do sleep 5; done

  kubeconfig-vip:
    desc: Update kubeconfig to use LoadBalancer VIP
    cmds:
      - talosctl kubeconfig -n {{.controller}} --force {{.ROOT_DIR}}/kubeconfig.yaml

  dns:
    desc: Install CoreDNS
    cmds:
      - kustomize build --enable-helm --load-restrictor=LoadRestrictionsNone {{.KUBERNETES_DIR}}/bootstrap/coredns | kubectl apply --server-side -f -
      - kubectl rollout status deployment/coredns -n kube-system --timeout=300s

  crds:
    desc: Install CRDs required by Flux apps
    cmds:
      - kubectl apply --server-side -k {{.KUBERNETES_DIR}}/bootstrap/crds

  flux:
    desc: Bootstrap Flux GitOps
    dir: "{{.KUBERNETES_DIR}}/bootstrap/flux"
    cmds:
      - kubectl apply --server-side -k {{.KUBERNETES_DIR}}/bootstrap/flux

      - sops --decrypt sops-age.sops.yaml | kubectl apply --server-side -f -
      - sops --decrypt github-deploy-key.sops.yaml | kubectl apply --server-side -f -

      - kubectl apply --server-side -k {{.KUBERNETES_DIR}}/flux/config

  validate-bgp:
    desc: Validate BGP peering
    cmds:
      - kubectl exec -n kube-system daemonset/cilium -- cilium bgp peers
