---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: qbtools-orphaned
spec:
  schedule: "@daily"
  timeZone: Europe/London
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      backoffLimit: 0
      ttlSecondsAfterFinished: 3600
      template:
        spec:
          restartPolicy: Never
          securityContext:
            runAsNonRoot: true
            runAsUser: 568
            runAsGroup: 568
            seccompProfile:
              type: RuntimeDefault
          containers:
            - name: orphaned
              image: ghcr.io/buroa/qbtools:v0.21.1@sha256:fd13085f7534719b7b30828684661b7f5611bbc4156831123775cfcd9b8f2eb5
              env:
                - name: TZ
                  value: Europe/London
                - name: QBITTORRENT_HOST
                  value: qbittorrent.default.svc.cluster.local
                - name: QBITTORRENT_PORT
                  value: "80"
                - name: SABNZBD_HOST
                  value: sabnzbd.default.svc.cluster.local
                - name: SABNZBD_PORT
                  value: "80"
              envFrom:
                - secretRef:
                    name: qbtools-secret
              args:
                - orphaned
                - --exclude-pattern
                - "*_unpackerred*"
                - --exclude-pattern
                - "*/manual/*"
                - --exclude-pattern
                - "*/orpheus/*"
              securityContext:
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true
                capabilities:
                  drop: ["ALL"]
              resources:
                requests:
                  cpu: 25m
                limits:
                  memory: 256M
              volumeMounts:
                - name: config
                  mountPath: /config
                  readOnly: true
                - name: data
                  mountPath: /data/downloads/torrents/complete
                  subPath: downloads/torrents/complete
          volumes:
            - name: config
              secret:
                secretName: qbtools-config-secret
            - name: data
              persistentVolumeClaim:
                claimName: bighorse-arr-media