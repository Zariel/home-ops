---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/source.toolkit.fluxcd.io/ocirepository_v1.json
apiVersion: source.toolkit.fluxcd.io/v1
kind: OCIRepository
metadata:
  name: forgejo
spec:
  interval: 15m
  layerSelector:
    mediaType: application/vnd.cncf.helm.chart.content.v1.tar+gzip
    operation: copy
  ref:
    tag: 15.0.3
  url: oci://code.forgejo.org/forgejo-helm/forgejo
---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: forgejo
spec:
  interval: 1h
  chartRef:
    kind: OCIRepository
    name: forgejo
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 2
      strategy: rollback
  values:
    strategy:
      type: Recreate
    image:
      rootless: true
    persistence:
      enabled: true
      create: false
      mount: true
      claimName: forgejo
    gitea:
      podAnnotations:
        reloader.stakater.com/auto: "true"
      admin:
        existingSecret: forgejo-secret
        username: admin
        email: git@cbannister.xyz
      metrics:
        enabled: true
        serviceMonitor:
          enabled: true
      config:
        APP_NAME: "Forgejo"
        RUN_MODE: prod
        server:
          DISABLE_SSH: false
          DOMAIN: git.cbannister.xyz
          ROOT_URL: https://git.cbannister.xyz
          LANDING_PAGE: explore
          SSH_DOMAIN: git.cbannister.xyz
          SSH_PORT: 22
        database:
          DB_TYPE: sqlite3
        service:
          DISABLE_REGISTRATION: true
          REQUIRE_SIGNIN_VIEW: false
        actions:
          ENABLED: true
        mailer:
          ENABLED: true
          PROTOCOL: smtp
          SMTP_ADDR: smtp-relay.default.svc.cluster.local
          SMTP_PORT: 25
          FROM: git@cbannister.xyz
        cache:
          ADAPTER: memory
        session:
          PROVIDER: memory
    service:
      http:
        type: ClusterIP
        port: 3000
      ssh:
        type: ClusterIP
        port: 22
