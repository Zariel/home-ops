apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    reloader.stakater.com/auto: "true"
  labels: &labels
    app.kubernetes.io/component: vector-aggregator
    app.kubernetes.io/instance: vector-aggregator
    app.kubernetes.io/name: vector-aggregator
  name: vector-aggregator
spec:
  replicas: 2
  selector:
    matchLabels: *labels
  template:
    metadata:
      labels: *labels
    spec:
      initContainers:
        - name: init-geoip
          image: ghcr.io/maxmind/geoipupdate:v7.1
          imagePullPolicy: IfNotPresent
          env:
            - name: GEOIPUPDATE_EDITION_IDS
              value: GeoLite2-Country
            - name: GEOIPUPDATE_FREQUENCY
              value: "0"
            - name: GEOIPUPDATE_VERBOSE
              value: "1"
          envFrom:
            - secretRef:
                name: vector-maxmind
          volumeMounts:
            - mountPath: /usr/share/GeoIP
              name: geoip
      containers:
        - name: app
          args:
            - --config
            - /etc/vector/vector.yaml
          image: docker.io/timberio/vector:0.51.0-alpine@sha256:cef2a4d33b43b3e9196ba0bd9f1d8b9006a03bfe15363514c5a0f78b8cb8e9d9
          imagePullPolicy: IfNotPresent
          livenessProbe: &probe
            failureThreshold: 3
            periodSeconds: 10
            successThreshold: 1
            tcpSocket:
              port: 8686
            timeoutSeconds: 1
          readinessProbe: *probe
          resources:
            requests:
              cpu: 200m
            limits:
              memory: 1Gi
          volumeMounts:
            - mountPath: /etc/vector/vector.yaml
              name: config
              readOnly: true
              subPath: vector.yaml
            - mountPath: /vector-data-dir
              name: data
            - mountPath: /usr/share/GeoIP
              name: geoip
          ports:
            - name: kubernetes
              containerPort: 6000
            - name: vyos
              containerPort: 6001
            - name: taloskernel
              containerPort: 6002
              protocol: UDP
            - name: talosservice
              containerPort: 6003
              protocol: UDP
      topologySpreadConstraints:
        - labelSelector:
            matchLabels:
              app.kubernetes.io/name: vector-aggregator
          maxSkew: 1
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: DoNotSchedule
      volumes:
        - name: config
          configMap:
            name: vector-aggregator-configmap
        - name: data
          emptyDir: {}
        - name: geoip
          emptyDir: {}
